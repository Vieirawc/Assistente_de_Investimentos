<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Simulador de Investimento</title>
    <style>
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background-color: #e9ecef; color: #333; }
        header { background-color: #003366; padding: 20px 50px; color: white; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.5em; font-weight: bold; color: #ffffff; }
        nav a { margin-left: 20px; text-decoration: none; color: #cfd8dc; font-weight: 500; transition: color 0.3s; }
        nav a:hover, nav a.active { color: #ffc107; }
        
        main { padding: 40px; display: flex; gap: 30px; justify-content: center; }
        .card { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); flex: 1; max-width: 500px; }
        h2 { color: #003366; margin-top: 0; }
        .empresa-info { background-color: #e3f2fd; padding: 15px; border-radius: 5px; margin-bottom: 20px; border-left: 5px solid #2196f3; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 1em; }
        
        .btn-calc { width: 100%; padding: 15px; background-color: #007bff; color: white; font-size: 1.1em; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-bottom: 10px; }
        .btn-calc:hover { background-color: #0069d9; }

        .btn-confirm { width: 100%; padding: 15px; background-color: #28a745; color: white; font-size: 1.1em; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 15px; }
        .btn-cancel { background: transparent; border: 1px solid rgba(255,255,255,0.5); color: white; padding: 10px; margin-top: 10px; cursor: pointer; width: 100%; border-radius: 5px; }

        #resultado-painel { display: none; background-color: #003366; color: white; padding: 25px; border-radius: 10px; text-align: center; margin-top: 20px; }
        .big-number { font-size: 2.5em; font-weight: bold; color: #ffc107; margin: 10px 0; }
        .meta-text { font-size: 1.1em; line-height: 1.5; }
    </style>
</head>
<body>

    <header>
        <div class="logo">FixInvest Web</div>
        <nav>
            <a href="index.html">Início</a>
            <a href="clientes.html">Clientes</a>
            <a href="cadastro.html">Cadastrar Parceiro</a>
            <a href="busca.html">Investir</a>
            <a href="estatisticas.html">Minha Carteira</a>
        </nav>
    </header>

    <main>
        <div class="card">
            <h2>Simular Contratação</h2>
            <div id="loading">Carregando dados da empresa...</div>
            
            <div id="dados-container" style="display: none;">
                <div class="empresa-info">
                    <h3 id="empresa-nome" style="margin:0 0 5px 0;">Empresa</h3>
                    <p style="margin:0;">Rentabilidade Anual: <strong id="empresa-rendimento">0%</strong></p>
                </div>

                <form id="simulacaoForm">
                    <div class="form-group">
                        <label>Selecione o Cliente:</label>
                        <select id="clienteSelect" required>
                            <option value="">Carregando clientes...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Investimento Inicial (R$):</label>
                        <input type="number" id="valorInicial" placeholder="Ex: 5000" required>
                    </div>

                    <div class="form-group">
                        <label>Aporte Mensal (R$) <small>(Opcional)</small>:</label>
                        <input type="number" id="aporteMensal" placeholder="Ex: 500" value="0">
                    </div>

                    <div class="form-group">
                        <label>Meta Financeira (R$):</label>
                        <input type="number" id="metaValor" placeholder="Ex: 100000" required>
                    </div>

                    <button type="submit" class="btn-calc">Calcular Previsão</button>
                </form>
            </div>
        </div>

        <div class="card" id="card-resultado" style="display:none;">
            <h2>Resultado da Previsão</h2>
            <div id="resultado-painel">
                <p>Para atingir a meta de <span id="res-meta" style="font-weight:bold;">R$ 0</span>:</p>
                
                <div class="meta-text" id="res-detalhe"></div>
                
                <div class="big-number" id="res-tempo">0 Anos</div>
                
                <p>Essa previsão atende suas expectativas?</p>
                
                <button id="btn-aceitar" class="btn-confirm">Confirmar Investimento</button>
                <button onclick="location.reload()" class="btn-cancel">Cancelar</button>
                
                <div id="msg-final" style="margin-top: 15px; font-weight: bold; color: #81ff8a;"></div>
            </div>
        </div>
    </main>

    <script>
        const apiUrl = 'http://localhost:5000';
        const urlParams = new URLSearchParams(window.location.search);
        const empresaId = urlParams.get('empresa');
        let dadosEmpresa = null;
        let simulacaoTemp = {};

        window.addEventListener('DOMContentLoaded', async () => {
            if(!empresaId) { alert('Erro: Empresa não selecionada'); return; }
            try {
                const resEmp = await fetch(`${apiUrl}/projects/${empresaId}`);
                dadosEmpresa = await resEmp.json();
                document.getElementById('empresa-nome').innerText = dadosEmpresa.nome;
                document.getElementById('empresa-rendimento').innerText = dadosEmpresa.rendimento + '%';
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dados-container').style.display = 'block';
            } catch (e) { alert('Erro ao carregar empresa'); }

            try {
                const resCli = await fetch(`${apiUrl}/clients`);
                const clientes = await resCli.json();
                const select = document.getElementById('clienteSelect');
                clientes.forEach(c => { select.innerHTML += `<option value="${c.id}">${c.nome} (${c.perfil})</option>`; });
            } catch (e) { console.error('Erro ao carregar clientes'); }
        });

        document.getElementById('simulacaoForm').addEventListener('submit', (e) => {
            e.preventDefault();

            const valorInicial = parseFloat(document.getElementById('valorInicial').value);
            const meta = parseFloat(document.getElementById('metaValor').value);
            const aporteMensal = parseFloat(document.getElementById('aporteMensal').value) || 0; // Captura aporte
            const taxaAnual = parseFloat(dadosEmpresa.rendimento);

            if (meta <= valorInicial) { alert("A meta deve ser maior que o investimento inicial!"); return; }
            if (taxaAnual <= 0) { alert("Rentabilidade inválida para cálculo."); return; }

            // --- MATEMÁTICA FINANCEIRA COM APORTE MENSAL ---
            // Taxa mensal aproximada
            const i = (taxaAnual / 100) / 12;
            
            // Fórmula para descobrir o Tempo (N) com Valor Futuro, Presente e Pagamento(Aporte)
            // n = ln( (FV * i + PMT) / (PV * i + PMT) ) / ln(1 + i)
            
            const numerador = (meta * i) + aporteMensal;
            const denominador = (valorInicial * i) + aporteMensal;
            const logaritmo = Math.log(numerador / denominador);
            const meses = logaritmo / Math.log(1 + i);
            
            const anos = meses / 12;
            let tempoTexto = (anos < 1) ? `${Math.ceil(meses)} Meses` : `${anos.toFixed(1)} Anos`;

            // UI Updates
            document.getElementById('card-resultado').style.display = 'block';
            document.getElementById('resultado-painel').style.display = 'block';
            document.getElementById('res-meta').innerText = meta.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
            document.getElementById('res-tempo').innerText = tempoTexto;
            
            let detalheTexto = `Taxa: ${taxaAnual}% a.a.`;
            if(aporteMensal > 0) {
                detalheTexto += ` | Aporte Mensal: R$ ${aporteMensal}`;
            }
            document.getElementById('res-detalhe').innerText = detalheTexto;

            simulacaoTemp = {
                cliente_id: document.getElementById('clienteSelect').value,
                empresa_id: empresaId,
                empresa_nome: dadosEmpresa.nome,
                valor_inicial: valorInicial,
                aporte_mensal: aporteMensal, // Salvando o aporte
                meta: meta,
                previsao_anos: anos.toFixed(2)
            };
        });

        document.getElementById('btn-aceitar').addEventListener('click', () => {
            fetch(`${apiUrl}/portfolio`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(simulacaoTemp)
            }).then(() => {
                document.getElementById('msg-final').innerText = "✅ Investimento Confirmado!";
                document.getElementById('btn-aceitar').style.display = 'none';
                setTimeout(() => { window.location.href = 'estatisticas.html'; }, 2000);
            });
        });
    </script>
</body>
</html>